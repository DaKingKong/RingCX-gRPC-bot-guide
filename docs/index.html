<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RingCX gRPC Streaming Implementation Guide</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <style>
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }
        @media (max-width: 767px) {
            .markdown-body {
                padding: 15px;
            }
        }
        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
        }
        @keyframes octocat-wave {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(-25deg); }
            40%, 80% { transform: rotate(10deg); }
        }
        .github-corner svg {
            fill: #151513;
            color: #fff;
            position: fixed;
            top: 0;
            border: 0;
            right: 0;
        }
        .github-corner .octo-arm {
            transform-origin: 130px 106px;
        }
    </style>
</head>
<body>
    <a href="https://github.com/DaKingKong/RingCX-gRPC-bot-guide" class="github-corner" aria-label="View source on GitHub">
        <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: fixed; top: 0; border: 0; right: 0;" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,91.3 206.9,94.7 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
        </svg>
    </a>
    <article class="markdown-body">
        <h1 id="ringcx-grpc-streaming-implementation-guide">RingCX gRPC Streaming Implementation Guide</h1>
<p>This guide will walk you through setting up a gRPC streaming service for RingCX, allowing you to receive real-time audio streams from calls.</p>
<p>This guide uses <code>python 3.11</code>.</p>
<p>At the moment only G.711 is supported end to end. Even if Workflow can set the auido property (though disabled at moment), it will be ignored and <code>g711u/a</code>, <code>ptime=100ms</code> and <code>sampling=8000hz</code> is used by RingCX VRU.</p>
<blockquote>
<p><strong>⚠️ Extra Notes:</strong> </p>
<p><strong>Cloud Platform Considerations:</strong> While the server can theoretically run on any cloud platform, some platforms have restrictions on which ports can be exposed. For example, Heroku doesn't allow developers to specify custom port numbers but we only support connecting to port <code>443</code> at the moment.</p>
<p><strong>Local Development with ngrok:</strong> Running locally via ngrok presents challenges due to port restrictions as well. TCP tunnels use their own port numbers rather than the required port 443. ngrok HTTPS tunnels use port 443 but encounter SSL certificate complications that prevent proper functionality.</p>
</blockquote>
<h2 id="1-create-a-virtual-environment-and-install-dependencies">1. Create a Virtual Environment and Install Dependencies</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create a virtual environment</span>
python<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>.venv

<span class="c1"># Activate the virtual environment</span>
<span class="c1"># On Windows:</span>
.venv/Scripts/activate
<span class="c1"># On Linux/Mac:</span>
<span class="nb">source</span><span class="w"> </span>.venv/bin/activate

<span class="c1"># Install dependencies</span>
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">grpcio</span><span class="o">==</span><span class="m">1</span>.71.0<span class="w"> </span>grpcio-tools<span class="o">==</span><span class="m">1</span>.29.0<span class="w"> </span><span class="nv">protobuf</span><span class="o">==</span><span class="m">5</span>.29.0
</code></pre></div>

<blockquote>
<p><strong>Note:</strong> If you encounter build errors with grpcio-tools on Windows, use pre-compiled wheels instead:
<code>bash
pip install --use-pep517 grpcio-tools</code>
Alternatively, install Microsoft Visual C++ Build Tools from <a href="https://visualstudio.microsoft.com/visual-cpp-build-tools/">visualstudio.microsoft.com</a></p>
</blockquote>
<p>For more advanced functionality (will be mentioned later), install additional dependencies:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># For transcription functionality</span>
pip<span class="w"> </span>install<span class="w"> </span>google-cloud-speech<span class="o">==</span><span class="m">2</span>.26.1

<span class="c1"># For file serving functionality</span>
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">flask</span><span class="o">==</span><span class="m">2</span>.3.3<span class="w"> </span><span class="nv">requests</span><span class="o">==</span><span class="m">2</span>.31.0
</code></pre></div>

<p>Alternatively, create a <code>requirements.txt</code> file with:</p>
<div class="codehilite"><pre><span></span><code><span class="n">grpcio</span><span class="o">==</span><span class="mf">1.71</span><span class="o">.</span><span class="mi">0</span>
<span class="n">grpcio</span><span class="o">-</span><span class="n">tools</span><span class="o">==</span><span class="mf">1.71</span><span class="o">.</span><span class="mi">0</span>
<span class="n">protobuf</span><span class="o">==</span><span class="mf">5.29</span><span class="o">.</span><span class="mi">0</span>
<span class="n">google</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">speech</span><span class="o">==</span><span class="mf">2.26</span><span class="o">.</span><span class="mi">1</span>
<span class="n">requests</span><span class="o">==</span><span class="mf">2.31</span><span class="o">.</span><span class="mi">0</span>
<span class="n">flask</span><span class="o">==</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">3</span>
</code></pre></div>

<p>And install with:</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div>

<h2 id="2-generate-grpc-code-from-protocol-buffers">2. Generate gRPC Code from Protocol Buffers</h2>
<p>First, save the following protobuf definition to a file named <code>ringcx_streaming.proto</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">syntax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;proto3&quot;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s">&quot;google/protobuf/empty.proto&quot;</span><span class="p">;</span>

<span class="kn">package</span><span class="w"> </span><span class="nn">ringcentral</span><span class="o">.</span><span class="n">ringcx.streaming.v1beta2</span><span class="p">;</span>

<span class="kd">enum</span><span class="w"> </span><span class="n">Codec</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">CODEC_UNSPECIFIED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="na">OPUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="na">PCMA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="na">PCMU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">  </span><span class="na">L16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">  </span><span class="na">FLAC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">enum</span><span class="w"> </span><span class="n">ProductType</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">PRODUCT_TYPE_UNSPECIFIED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="na">QUEUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="na">CAMPAIGN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="na">IVR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="c1">// RFU</span>
<span class="p">}</span>

<span class="kd">enum</span><span class="w"> </span><span class="n">DialogType</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">DIALOG_TYPE_UNSPECIFIED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="na">INBOUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="na">OUTBOUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">enum</span><span class="w"> </span><span class="n">ParticipantType</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">PARTICIPANT_TYPE_UNSPECIFIED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="na">CONTACT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="na">AGENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="na">BOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="c1">// yes, value is 5</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">Account</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">sub_account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">rc_account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">Product</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">ProductType</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">Dialog</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">DialogType</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="na">ani</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">  </span><span class="k">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="na">dnis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">  </span><span class="k">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="na">language</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="c1">// https://www.rfc-editor.org/rfc/bcp/bcp47.txt</span>
<span class="w">  </span><span class="n">map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="p">&gt;</span><span class="w"> </span><span class="na">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">Participant</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">ParticipantType</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">AudioFormat</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Codec</span><span class="w"> </span><span class="na">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32</span><span class="w"> </span><span class="na">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">  </span><span class="c1">// must be 8000 for now</span>
<span class="w">  </span><span class="kt">uint32</span><span class="w"> </span><span class="na">ptime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="c1">// size of audio chunks in msec</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">AudioContent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">bytes</span><span class="w"> </span><span class="na">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32</span><span class="w"> </span><span class="na">seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">      </span><span class="c1">// could be repeated</span>
<span class="w">  </span><span class="kt">uint32</span><span class="w"> </span><span class="na">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="c1">// in msec</span>
<span class="p">}</span>

<span class="kd">service</span><span class="w"> </span><span class="n">Streaming</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// For each Dialog, gRPC client makes single &#39;Stream&#39; call toward server and all &#39;StreamEvent&#39; messages are sent over the established stream</span>
<span class="w">  </span><span class="c1">// Server does not return any response/stream back</span>
<span class="w">  </span><span class="k">rpc</span><span class="w"> </span><span class="n">Stream</span><span class="p">(</span><span class="n">stream</span><span class="w"> </span><span class="n">StreamEvent</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">google.protobuf.Empty</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">StreamEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">oneof</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DialogInitEvent</span><span class="w"> </span><span class="na">dialog_init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">SegmentStartEvent</span><span class="w"> </span><span class="na">segment_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="n">SegmentMediaEvent</span><span class="w"> </span><span class="na">segment_media</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">SegmentInfoEvent</span><span class="w"> </span><span class="na">segment_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="n">SegmentStopEvent</span><span class="w"> </span><span class="na">segment_stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">DialogInitEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Account</span><span class="w"> </span><span class="na">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">Dialog</span><span class="w"> </span><span class="na">dialog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">SegmentStartEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">segment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">optional</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="na">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="n">Participant</span><span class="w"> </span><span class="na">participant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">  </span><span class="k">optional</span><span class="w"> </span><span class="n">AudioFormat</span><span class="w"> </span><span class="na">audio_format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">SegmentMediaEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">segment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">AudioContent</span><span class="w"> </span><span class="na">audio_content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">SegmentInfoEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">segment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="na">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">SegmentStopEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">segment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Now generate the Python gRPC code:</p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>-m<span class="w"> </span>grpc_tools.protoc<span class="w"> </span>-I.<span class="w"> </span>--python_out<span class="o">=</span>.<span class="w"> </span>--pyi_out<span class="o">=</span>.<span class="w"> </span>--grpc_python_out<span class="o">=</span>.<span class="w"> </span>ringcx_streaming.proto
</code></pre></div>

<p>This will create three files:
- <code>ringcx_streaming_pb2.py</code>: Contains message classes
- <code>ringcx_streaming_pb2_grpc.py</code>: Contains service classes
- <code>ringcx_streaming_pb2.pyi</code>: Type hints for the generated code</p>
<h2 id="3-set-up-simple-server-with-ssl">3. Set Up Simple Server with SSL</h2>
<p>Create <code>simple_server.py</code>:</p>
<details>
<summary>Click to expand simple_server.py</summary>


<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">ringcx_streaming_pb2_grpc</span>
<span class="kn">from</span> <span class="nn">google.protobuf.empty_pb2</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;simple-speech-server&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StreamingService</span><span class="p">(</span><span class="n">ringcx_streaming_pb2_grpc</span><span class="o">.</span><span class="n">StreamingServicer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">Stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_iterator</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server started, waiting for audio stream...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stream_event</span> <span class="ow">in</span> <span class="n">request_iterator</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stream_event</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;segment_media&#39;</span><span class="p">):</span>
                    <span class="n">payload_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_event</span><span class="o">.</span><span class="n">segment_media</span><span class="o">.</span><span class="n">audio_content</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received segment media with payload size: </span><span class="si">{</span><span class="n">payload_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received other stream event type&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stream completed.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during stream processing: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">set_code</span><span class="p">(</span><span class="n">grpc</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">INTERNAL</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">set_details</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stream processing error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Empty</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">serve</span><span class="p">():</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ringcx_streaming_pb2_grpc</span><span class="o">.</span><span class="n">add_StreamingServicer_to_server</span><span class="p">(</span>
        <span class="n">StreamingService</span><span class="p">(),</span> <span class="n">server</span>
    <span class="p">)</span>

    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="n">cert_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSL_CERT_FILE&#39;</span><span class="p">)</span>
    <span class="n">key_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSL_KEY_FILE&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cert_file</span> <span class="ow">and</span> <span class="n">key_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cert_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">key_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">key_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">server_credentials</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">ssl_server_credentials</span><span class="p">([(</span><span class="n">key_data</span><span class="p">,</span> <span class="n">cert_data</span><span class="p">)])</span>
        <span class="n">server</span><span class="o">.</span><span class="n">add_secure_port</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">server_credentials</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server started with SSL at </span><span class="si">{</span><span class="n">server_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">add_insecure_port</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server started without SSL at </span><span class="si">{</span><span class="n">server_address</span><span class="si">}</span><span class="s2"> (insecure)&quot;</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">graceful_shutdown</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received signal to terminate. Shutting down server gracefully...&quot;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">grace</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server stopped successfully&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">graceful_shutdown</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">graceful_shutdown</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">wait_for_termination</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupt received. Shutting down server gracefully...&quot;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">grace</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server stopped successfully&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting simple server&quot;</span><span class="p">)</span>
        <span class="n">serve</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupt received. Exiting...&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Critical error in main loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>



</details>

<h3 id="generate-local-ssl-certificates">Generate Local SSL Certificates</h3>
<p>For production, use a proper SSL certificate from a trusted certificate authority. For testing, generate self-signed certificates (fields can all be empty for a default registration):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Generate private key</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>server.key<span class="w"> </span><span class="m">2048</span>

<span class="c1"># Generate certificate signing request</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.csr

<span class="c1"># Generate self-signed certificate (valid for 365 days)</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-in<span class="w"> </span>server.csr<span class="w"> </span>-signkey<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.crt
</code></pre></div>

<h4 id="for-online-instances-aws-ec2">For Online Instances (AWS EC2)</h4>
<p>When generating certificates on EC2, you need to specify the Common Name (CN) that matches your server's public DNS or IP:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Generate private key</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>server.key<span class="w"> </span><span class="m">2048</span>

<span class="c1"># Generate CSR with specific info (especially Common Name)</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.csr<span class="w"> </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/ST=State/L=City/O=Organization/OU=Unit/CN=your-ec2-public-dns-or-ip&quot;</span>
<span class="c1"># Example: &quot;/CN=ec2-12-34-56-78.compute-1.amazonaws.com&quot; or &quot;/CN=12.34.56.78&quot;</span>

<span class="c1"># Generate self-signed certificate</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-in<span class="w"> </span>server.csr<span class="w"> </span>-signkey<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.crt
</code></pre></div>

<p>Note: If using an IP address, some clients might still show security warnings since they expect domain names.</p>
<h3 id="run-the-server-with-ssl">Run the Server with SSL</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Set environment variables for SSL certificate paths</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SSL_CERT_FILE</span><span class="o">=</span>/path/to/server.crt
<span class="nb">export</span><span class="w"> </span><span class="nv">SSL_KEY_FILE</span><span class="o">=</span>/path/to/server.key
<span class="nb">export</span><span class="w"> </span><span class="nv">PORT</span><span class="o">=</span><span class="m">443</span>

<span class="c1"># Run the server</span>
python<span class="w"> </span>simple_server.py
</code></pre></div>

<h2 id="4-configure-ringcx-workflow">4. Configure RingCX Workflow</h2>
<p>Now that our gRPC server is up and running, we want to configure RingCX:</p>
<ol>
<li>Log in to your RingCX admin portal</li>
<li>In Routing, create a new voice queue. Assign number and agents to it.</li>
<li>Navigate to "Workflows" section and create a new workflow</li>
<li>Assign a number to it (the number is what you would call later in test)</li>
<li>Go to Workflow Studio, we want 2 lanes:</li>
<li>Start -&gt; Route (route to the voice queue you just created)</li>
<li>On_Agent_Connected -&gt; Start_streaming (URL: <code>grpc://your-server-domain:443</code>, only port <code>443</code> is supported at the moment)</li>
<li>Save the workflow</li>
</ol>
<h2 id="5-test-the-setup">5. Test the Setup</h2>
<ol>
<li>Make a test call to the queue you configured</li>
<li>Monitor your server logs for incoming audio streams</li>
<li>You should see log messages indicating receipt of stream events and audio data:
   <code>bash
   # Upon call connection, it will show logs like this
   2025-04-29 06:12:17,007 - simple-speech-server - INFO - Received segment media with payload size: 800 bytes</code></li>
</ol>
<h2 id="6-advanced-server-implementations">6. Advanced Server Implementations</h2>
<h3 id="61-file-server-save-and-playback-audio">6.1 File Server (Save and Playback Audio)</h3>
<p>For a more advanced implementation that saves audio segments as WAV files and hosts them for playback:</p>
<p>Create <code>file_server.py</code>:</p>
<details>
<summary>Click to expand file_server.py</summary>


<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">wave</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
<span class="kn">from</span> <span class="nn">google.protobuf.empty_pb2</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">ringcx_streaming_pb2</span>
<span class="kn">import</span> <span class="nn">ringcx_streaming_pb2_grpc</span>
<span class="kn">import</span> <span class="nn">audioop</span>
<span class="kn">import</span> <span class="nn">queue</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">OUTPUT_FOLDER</span> <span class="o">=</span> <span class="s1">&#39;saved_audio&#39;</span>

<span class="c1"># HTML template for the web page</span>
<span class="n">HTML_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;!DOCTYPE html&gt;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">&lt;head&gt;</span>
<span class="s2">    &lt;title&gt;Audio Recordings&lt;/title&gt;</span>
<span class="s2">    &lt;style&gt;</span>
<span class="s2">        body {</span>
<span class="s2">            font-family: Arial, sans-serif;</span>
<span class="s2">            max-width: 900px;</span>
<span class="s2">            margin: 0 auto;</span>
<span class="s2">            padding: 20px;</span>
<span class="s2">        }</span>
<span class="s2">        h1, h2, h3 {</span>
<span class="s2">            color: #333;</span>
<span class="s2">        }</span>
<span class="s2">        ul {</span>
<span class="s2">            list-style-type: none;</span>
<span class="s2">            padding: 0;</span>
<span class="s2">        }</span>
<span class="s2">        li {</span>
<span class="s2">            border: 1px solid #ddd;</span>
<span class="s2">            margin-bottom: 10px;</span>
<span class="s2">            padding: 10px;</span>
<span class="s2">            border-radius: 4px;</span>
<span class="s2">        }</span>
<span class="s2">        audio {</span>
<span class="s2">            width: 100%;</span>
<span class="s2">        }</span>
<span class="s2">        .timestamp {</span>
<span class="s2">            color: #666;</span>
<span class="s2">            font-size: 0.8em;</span>
<span class="s2">        }</span>
<span class="s2">        .session {</span>
<span class="s2">            margin-bottom: 30px;</span>
<span class="s2">            border: 1px solid #eee;</span>
<span class="s2">            padding: 15px;</span>
<span class="s2">            border-radius: 8px;</span>
<span class="s2">            background-color: #f9f9f9;</span>
<span class="s2">        }</span>
<span class="s2">    &lt;/style&gt;</span>
<span class="s2">&lt;/head&gt;</span>
<span class="s2">&lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;Recorded Audio Files&lt;/h1&gt;</span>

<span class="s2">    {</span><span class="si">% i</span><span class="s2">f sessions %}</span>
<span class="s2">        {</span><span class="si">% f</span><span class="s2">or session_id, files in sessions.items() %}</span>
<span class="s2">            &lt;div class=&quot;session&quot;&gt;</span>
<span class="s2">                &lt;h2&gt;Session: {{ session_id }}&lt;/h2&gt;</span>

<span class="s2">                {</span><span class="si">% i</span><span class="s2">f files.wav_files %}</span>
<span class="s2">                    &lt;h3&gt;WAV Files (Playable)&lt;/h3&gt;</span>
<span class="s2">                    &lt;ul&gt;</span>
<span class="s2">                    {</span><span class="si">% f</span><span class="s2">or file_path in files.wav_files %}</span>
<span class="s2">                        {</span><span class="si">% s</span><span class="s2">et file_name = file_path.split(&#39;/&#39;)[-1] %}</span>
<span class="s2">                        &lt;li&gt;</span>
<span class="s2">                            &lt;div&gt;{{ file_name }}&lt;/div&gt;</span>
<span class="s2">                            &lt;audio controls&gt;</span>
<span class="s2">                                &lt;source src=&quot;/files/{{ file_path }}&quot; type=&quot;audio/wav&quot;&gt;</span>
<span class="s2">                                Your browser does not support the audio element.</span>
<span class="s2">                            &lt;/audio&gt;</span>
<span class="s2">                        &lt;/li&gt;</span>
<span class="s2">                    {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">                    &lt;/ul&gt;</span>
<span class="s2">                {</span><span class="si">% e</span><span class="s2">ndif %}</span>

<span class="s2">                {</span><span class="si">% i</span><span class="s2">f files.bin_files %}</span>
<span class="s2">                    &lt;h3&gt;Raw Binary Files&lt;/h3&gt;</span>
<span class="s2">                    &lt;ul&gt;</span>
<span class="s2">                    {</span><span class="si">% f</span><span class="s2">or file_path in files.bin_files %}</span>
<span class="s2">                        {</span><span class="si">% s</span><span class="s2">et file_name = file_path.split(&#39;/&#39;)[-1] %}</span>
<span class="s2">                        &lt;li&gt;</span>
<span class="s2">                            &lt;a href=&quot;/files/{{ file_path }}&quot;&gt;{{ file_name }}&lt;/a&gt;</span>
<span class="s2">                        &lt;/li&gt;</span>
<span class="s2">                    {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">                    &lt;/ul&gt;</span>
<span class="s2">                {</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">lse %}</span>
<span class="s2">        &lt;p&gt;No audio recordings found.&lt;/p&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">StreamingService</span><span class="p">(</span><span class="n">ringcx_streaming_pb2_grpc</span><span class="o">.</span><span class="n">StreamingServicer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary to track all active segments</span>

    <span class="k">def</span> <span class="nf">Stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_iterator</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># Create output directory</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">request_iterator</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">session_id</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;dialog_init&#39;</span><span class="p">):</span>
                <span class="n">dialog_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">dialog_init</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: DialogInit, dialog_id: </span><span class="si">{</span><span class="n">dialog_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">create_session_dir</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
                <span class="n">write_session_logs</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;DialogInit: </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;segment_start&#39;</span><span class="p">):</span>
                <span class="n">segment_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">segment_start</span><span class="o">.</span><span class="n">segment_id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: SegmentStart, segment_id: </span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create entry for this segment</span>
                <span class="n">segment_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
                    <span class="s1">&#39;segment_id&#39;</span><span class="p">:</span> <span class="n">segment_id</span><span class="p">,</span>
                    <span class="s1">&#39;audio_format&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;audio_data&#39;</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">()</span>
                <span class="p">}</span>

                <span class="c1"># Extract audio format from segment_start if available</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">segment_start</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;audio_format&#39;</span><span class="p">):</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">segment_start</span><span class="o">.</span><span class="n">audio_format</span>
                    <span class="n">codec_name</span> <span class="o">=</span> <span class="n">ringcx_streaming_pb2</span><span class="o">.</span><span class="n">Codec</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">codec</span><span class="p">)</span>

                    <span class="c1"># Store audio format for this specific segment</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">][</span><span class="s1">&#39;audio_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;encoding&#39;</span><span class="p">:</span> <span class="n">codec_name</span><span class="p">,</span>
                        <span class="s1">&#39;sample_rate&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span>
                        <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="mi">1</span>  <span class="c1"># Default to mono</span>
                    <span class="p">}</span>

                    <span class="c1"># Set sample width based on codec</span>
                    <span class="k">if</span> <span class="n">codec_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PCMA&#39;</span><span class="p">,</span> <span class="s1">&#39;PCMU&#39;</span><span class="p">]:</span>  <span class="c1"># A-law and μ-law are 8-bit</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">][</span><span class="s1">&#39;audio_format&#39;</span><span class="p">][</span><span class="s1">&#39;sample_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">codec_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L16&#39;</span><span class="p">,</span> <span class="s1">&#39;LINEAR16&#39;</span><span class="p">]:</span>  <span class="c1"># 16-bit PCM</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">][</span><span class="s1">&#39;audio_format&#39;</span><span class="p">][</span><span class="s1">&#39;sample_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;segment_media&#39;</span><span class="p">):</span>
                <span class="n">segment_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">segment_media</span><span class="o">.</span><span class="n">segment_id</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">segment_media</span><span class="o">.</span><span class="n">audio_content</span><span class="o">.</span><span class="n">payload</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">segment_media</span><span class="o">.</span><span class="n">audio_content</span><span class="o">.</span><span class="n">seq</span>

                <span class="n">segment_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: SegmentMedia, segment_id: </span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">, seq: </span><span class="si">{</span><span class="n">seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Store audio data</span>
                <span class="k">if</span> <span class="n">segment_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                    <span class="c1"># Save audio content to file</span>
                    <span class="n">write_audio_content</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">segment_id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
                    <span class="c1"># Append to in-memory buffer</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">][</span><span class="s1">&#39;audio_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;segment_stop&#39;</span><span class="p">):</span>
                <span class="n">segment_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">segment_stop</span><span class="o">.</span><span class="n">segment_id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: SegmentStop, segment_id: </span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Process completed segment</span>
                <span class="n">segment_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">segment_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                    <span class="c1"># Convert audio to WAV for playback</span>
                    <span class="n">audio_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">][</span><span class="s1">&#39;audio_format&#39;</span><span class="p">]</span>
                    <span class="n">convert_bin_to_wav</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">segment_id</span><span class="p">,</span> <span class="n">audio_format</span><span class="p">)</span>

                    <span class="c1"># Clean up</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">]</span>

        <span class="c1"># Clean up any remaining segments</span>
        <span class="n">segments_to_remove</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">segment_key</span> <span class="ow">in</span> <span class="n">segments_to_remove</span><span class="p">:</span>
            <span class="n">segment_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">]</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">segment_data</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span>
            <span class="n">segment_id</span> <span class="o">=</span> <span class="n">segment_data</span><span class="p">[</span><span class="s1">&#39;segment_id&#39;</span><span class="p">]</span>

            <span class="c1"># Convert to WAV</span>
            <span class="n">audio_format</span> <span class="o">=</span> <span class="n">segment_data</span><span class="p">[</span><span class="s1">&#39;audio_format&#39;</span><span class="p">]</span>
            <span class="n">convert_bin_to_wav</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">segment_id</span><span class="p">,</span> <span class="n">audio_format</span><span class="p">)</span>

            <span class="c1"># Clean up</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_key</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Empty</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">serve</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">grpc_port</span><span class="p">,</span> <span class="n">grpc_secure_port</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ringcx_streaming_pb2_grpc</span><span class="o">.</span><span class="n">add_StreamingServicer_to_server</span><span class="p">(</span><span class="n">StreamingService</span><span class="p">(),</span> <span class="n">server</span><span class="p">)</span>

    <span class="c1"># Insecure port</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">server_ip</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">grpc_port</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">add_insecure_port</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gRPC server started at </span><span class="si">{</span><span class="n">server_address</span><span class="si">}</span><span class="s1"> (insecure)&#39;</span><span class="p">)</span>

    <span class="c1"># Secure port if SSL certificates are available</span>
    <span class="n">cert_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSL_CERT_FILE&#39;</span><span class="p">)</span>
    <span class="n">key_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSL_KEY_FILE&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cert_file</span> <span class="ow">and</span> <span class="n">key_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key_file</span><span class="p">):</span>
        <span class="n">secure_address</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">server_ip</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">grpc_secure_port</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cert_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">key_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">key_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">server_credentials</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">ssl_server_credentials</span><span class="p">([(</span><span class="n">key_data</span><span class="p">,</span> <span class="n">cert_data</span><span class="p">)])</span>
        <span class="n">server</span><span class="o">.</span><span class="n">add_secure_port</span><span class="p">(</span><span class="n">secure_address</span><span class="p">,</span> <span class="n">server_credentials</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gRPC server started with SSL at </span><span class="si">{</span><span class="n">secure_address</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">server</span>

<span class="k">def</span> <span class="nf">configure_logger</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="n">log_filename</span><span class="p">):</span>
    <span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_filename</span><span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_logger</span>


<span class="k">def</span> <span class="nf">create_session_dir</span><span class="p">(</span><span class="n">session_id</span><span class="p">):</span>
    <span class="n">output_folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">OUTPUT_FOLDER</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output_folder_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_session_logs</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">OUTPUT_FOLDER</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s1">/session.log&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_audio_content</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">segment_id</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">OUTPUT_FOLDER</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s1">.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">convert_bin_to_wav</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">segment_id</span><span class="p">,</span> <span class="n">audio_format</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert binary audio file to WAV format&quot;&quot;&quot;</span>
    <span class="n">bin_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">OUTPUT_FOLDER</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s1">.bin&#39;</span>
    <span class="n">wav_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">OUTPUT_FOLDER</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s1">.wav&#39;</span>

    <span class="c1"># Check if binary file exists and has content</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bin_file</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">bin_file</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binary file </span><span class="si">{</span><span class="n">bin_file</span><span class="si">}</span><span class="s2"> is empty or doesn&#39;t exist&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Ensure we have the minimum required audio format parameters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">audio_format</span> <span class="ow">or</span> <span class="s1">&#39;sample_rate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">audio_format</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing audio format information for </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Set default values if not provided</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="n">audio_format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Default to mono</span>
    <span class="n">sample_width</span> <span class="o">=</span> <span class="n">audio_format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_width&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Default to 8-bit</span>
    <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">audio_format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>  <span class="c1"># Default to 8kHz</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">audio_format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;PCMU&#39;</span><span class="p">)</span>  <span class="c1"># Default to PCM</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read binary data</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bin_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">audio_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># Convert based on codec type</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s1">&#39;PCMA&#39;</span><span class="p">:</span>  <span class="c1"># A-law</span>
            <span class="c1"># Convert A-law to PCM (2 bytes per sample)</span>
            <span class="n">audio_data</span> <span class="o">=</span> <span class="n">audioop</span><span class="o">.</span><span class="n">alaw2lin</span><span class="p">(</span><span class="n">audio_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">sample_width</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># A-law conversion results in 16-bit PCM</span>

        <span class="k">elif</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s1">&#39;PCMU&#39;</span><span class="p">:</span>  <span class="c1"># μ-law</span>
            <span class="c1"># Convert μ-law to PCM (2 bytes per sample)</span>
            <span class="n">audio_data</span> <span class="o">=</span> <span class="n">audioop</span><span class="o">.</span><span class="n">ulaw2lin</span><span class="p">(</span><span class="n">audio_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">sample_width</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># μ-law conversion results in 16-bit PCM</span>

        <span class="k">elif</span> <span class="n">encoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L16&#39;</span><span class="p">,</span> <span class="s1">&#39;LINEAR16&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported codec: </span><span class="si">{</span><span class="n">encoding</span><span class="si">}</span><span class="s2">, using raw data&quot;</span><span class="p">)</span>

        <span class="c1"># Create WAV file</span>
        <span class="k">with</span> <span class="n">wave</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">wav_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wf</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">setnchannels</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">setsampwidth</span><span class="p">(</span><span class="n">sample_width</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">setframerate</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">bin_file</span><span class="si">}</span><span class="s2"> to WAV format: </span><span class="si">{</span><span class="n">wav_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting </span><span class="si">{</span><span class="n">bin_file</span><span class="si">}</span><span class="s2"> to WAV: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_all_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">creation_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">creation_time</span><span class="p">))</span>

    <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">run_flask</span><span class="p">(</span><span class="n">http_port</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Flask server on port </span><span class="si">{</span><span class="n">http_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">http_port</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/health&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">healthcheck</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_files</span><span class="p">():</span>
    <span class="c1"># Group files by session ID</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Get all files</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="n">get_all_files</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
        <span class="c1"># Skip session log files from the main listing</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/session.log&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="c1"># For session_segment named files</span>
            <span class="n">session_segment</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Remove extension</span>
            <span class="k">if</span> <span class="n">session_segment</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">session_segment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">session_id</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
                        <span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wav_files&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;bin_files&#39;</span><span class="p">:</span> <span class="p">[]}</span>

                    <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.wav&#39;</span><span class="p">):</span>
                        <span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">][</span><span class="s1">&#39;wav_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bin&#39;</span><span class="p">):</span>
                        <span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">][</span><span class="s1">&#39;bin_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># For files organized in session directories</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
                <span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wav_files&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;bin_files&#39;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.wav&#39;</span><span class="p">):</span>
                <span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">][</span><span class="s1">&#39;wav_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bin&#39;</span><span class="p">):</span>
                <span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">][</span><span class="s1">&#39;bin_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="c1"># Sort sessions and files</span>
    <span class="n">sorted_sessions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sorted_sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;wav_files&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">][</span><span class="s1">&#39;wav_files&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;bin_files&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">][</span><span class="s1">&#39;bin_files&#39;</span><span class="p">])</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">HTML_TEMPLATE</span><span class="p">,</span> <span class="n">sessions</span><span class="o">=</span><span class="n">sorted_sessions</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/files/&lt;path:filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.log&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">file_content</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/files&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_list_files</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint to list all audio files&quot;&quot;&quot;</span>
    <span class="n">wav_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.wav&#39;</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">OUTPUT_FOLDER</span><span class="p">)</span>
                <span class="n">wav_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">wav_files</span><span class="p">})</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Configuration with hardcoded values</span>
    <span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
    <span class="n">log_filename</span> <span class="o">=</span> <span class="s2">&quot;server.log&quot;</span>
    <span class="n">server_ip</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
    <span class="n">grpc_port</span> <span class="o">=</span> <span class="mi">10080</span>
    <span class="n">grpc_secure_port</span> <span class="o">=</span> <span class="mi">443</span>
    <span class="n">http_port</span> <span class="o">=</span> <span class="mi">8080</span>

    <span class="c1"># Configure logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">configure_logger</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="n">log_filename</span><span class="p">)</span>

    <span class="c1"># Create output folders if they don&#39;t exist</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Start gRPC server</span>
    <span class="n">grpc_server</span> <span class="o">=</span> <span class="n">serve</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">grpc_port</span><span class="p">,</span> <span class="n">grpc_secure_port</span><span class="p">)</span>

    <span class="c1"># Start Flask server in a separate thread</span>
    <span class="n">flask_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_flask</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">http_port</span><span class="p">,))</span>
    <span class="n">flask_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">flask_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Keep the main thread running</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">86400</span><span class="p">)</span>  <span class="c1"># Sleep for a day</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server shutdown initiated&quot;</span><span class="p">)</span>
        <span class="n">grpc_server</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>



</details>

<div class="codehilite"><pre><span></span><code><span class="c1"># Install additional required packages (if you haven&#39;t done this above)</span>
pip<span class="w"> </span>install<span class="w"> </span>flask

<span class="c1"># Export SSL environment variables as before</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SSL_CERT_FILE</span><span class="o">=</span>/path/to/server.crt
<span class="nb">export</span><span class="w"> </span><span class="nv">SSL_KEY_FILE</span><span class="o">=</span>/path/to/server.key
<span class="nb">export</span><span class="w"> </span><span class="nv">PORT</span><span class="o">=</span><span class="m">443</span>

<span class="c1"># Run the file server</span>
python<span class="w"> </span>file_server.py
</code></pre></div>

<p>The <code>file_server.py</code> script will:
- Save incoming audio streams as binary files
- Convert them to WAV format for playback
- Host a simple web server to browse and play recorded files</p>
<p>Access the web interface at: <code>http://your-server-address:8080/</code></p>
<h3 id="62-transcription-server-real-time-speech-to-text">6.2 Transcription Server (Real-time Speech-to-Text)</h3>
<p>Create <code>transcribe_server.py</code>:</p>
<details>
<summary>Click to expand transcribe_server.py</summary>


<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">speech</span>
<span class="kn">import</span> <span class="nn">ringcx_streaming_pb2_grpc</span>
<span class="kn">from</span> <span class="nn">google.protobuf.empty_pb2</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;speech-server&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StreamingService</span><span class="p">(</span><span class="n">ringcx_streaming_pb2_grpc</span><span class="o">.</span><span class="n">StreamingServicer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">Stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_iterator</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server started, waiting for audio stream...&quot;</span><span class="p">)</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">speech</span><span class="o">.</span><span class="n">SpeechClient</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">speech</span><span class="o">.</span><span class="n">RecognitionConfig</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">speech</span><span class="o">.</span><span class="n">RecognitionConfig</span><span class="o">.</span><span class="n">AudioEncoding</span><span class="o">.</span><span class="n">MULAW</span><span class="p">,</span>
            <span class="n">sample_rate_hertz</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
            <span class="n">language_code</span><span class="o">=</span><span class="s2">&quot;en-US&quot;</span><span class="p">,</span>
            <span class="n">enable_automatic_punctuation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">streaming_config</span> <span class="o">=</span> <span class="n">speech</span><span class="o">.</span><span class="n">StreamingRecognitionConfig</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">interim_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">audio_generator</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">stream_event</span> <span class="ow">in</span> <span class="n">request_iterator</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stream_event</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s1">&#39;segment_media&#39;</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">speech</span><span class="o">.</span><span class="n">StreamingRecognizeRequest</span><span class="p">(</span>
                        <span class="n">audio_content</span><span class="o">=</span><span class="n">stream_event</span><span class="o">.</span><span class="n">segment_media</span><span class="o">.</span><span class="n">audio_content</span><span class="o">.</span><span class="n">payload</span>
                    <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>            
            <span class="n">responses</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">streaming_recognize</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">streaming_config</span><span class="p">,</span>
                <span class="n">requests</span><span class="o">=</span><span class="n">audio_generator</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_final</span><span class="p">:</span>
                    <span class="n">transcript</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transcript</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transcription: </span><span class="si">{</span><span class="n">transcript</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transcription completed.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during transcription: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">set_code</span><span class="p">(</span><span class="n">grpc</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">INTERNAL</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">set_details</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transcription error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Empty</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">serve</span><span class="p">():</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ringcx_streaming_pb2_grpc</span><span class="o">.</span><span class="n">add_StreamingServicer_to_server</span><span class="p">(</span>
        <span class="n">StreamingService</span><span class="p">(),</span> <span class="n">server</span>
    <span class="p">)</span>

    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span> <span class="c1"># We only support 443 port at the moment</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="n">cert_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSL_CERT_FILE&#39;</span><span class="p">)</span>
    <span class="n">key_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSL_KEY_FILE&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cert_file</span> <span class="ow">and</span> <span class="n">key_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cert_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">key_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">key_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">server_credentials</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">ssl_server_credentials</span><span class="p">([(</span><span class="n">key_data</span><span class="p">,</span> <span class="n">cert_data</span><span class="p">)])</span>
        <span class="n">server</span><span class="o">.</span><span class="n">add_secure_port</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">server_credentials</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server started with SSL at </span><span class="si">{</span><span class="n">server_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">add_insecure_port</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server started without SSL at </span><span class="si">{</span><span class="n">server_address</span><span class="si">}</span><span class="s2"> (insecure)&quot;</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">graceful_shutdown</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received signal to terminate. Shutting down server gracefully...&quot;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">grace</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server stopped successfully&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">graceful_shutdown</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">graceful_shutdown</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">wait_for_termination</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupt received. Shutting down server gracefully...&quot;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">grace</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server stopped successfully&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting server&quot;</span><span class="p">)</span>
        <span class="n">serve</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keyboard interrupt received. Exiting...&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Critical error in main loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</code></pre></div>



</details>

<p>To implement real-time transcription using Google Speech-to-Text:</p>
<ol>
<li>Set up Google Cloud account and create a project</li>
<li>Enable the Speech-to-Text API for your project</li>
<li>Create a service account and download credentials JSON file</li>
<li>Set the environment variable to point to your credentials:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">GOOGLE_APPLICATION_CREDENTIALS</span><span class="o">=</span>/path/to/your-credentials.json
<span class="nb">export</span><span class="w"> </span><span class="nv">SSL_CERT_FILE</span><span class="o">=</span>/path/to/server.crt
<span class="nb">export</span><span class="w"> </span><span class="nv">SSL_KEY_FILE</span><span class="o">=</span>/path/to/server.key
<span class="nb">export</span><span class="w"> </span><span class="nv">PORT</span><span class="o">=</span><span class="m">443</span>

<span class="c1"># Run the transcription server</span>
python<span class="w"> </span>transcribe_server.py
</code></pre></div>

<p>The transcription server will convert incoming audio to text in real-time and log the transcriptions. </p>
<p>For design simplicity, it transcribes all content from both parties, which would have better text output if one party is audible and the other is muted.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li><strong>SSL Connection Issues</strong>: Ensure your certificates are valid and properly configured</li>
<li><strong>gRPC Connection Failures</strong>: Check that your server is accessible from RingCX network and ports are properly opened</li>
<li><strong>No Audio Data</strong>: Verify that the workflow is correctly associated with the call queue</li>
<li><strong>Transcription Issues</strong>: Check your Google Cloud credentials and ensure the Speech-to-Text API is enabled</li>
</ul>
<h2 id="further-development">Further Development</h2>
<p>You can extend the provided server implementations to:
- Store transcriptions in a database
- Perform sentiment analysis on transcriptions
- Integrate with other services via webhooks
- Implement custom audio processing logic</p>
<p>For any questions or support, please contact your RingCX representative. </p>
    </article>
</body>
</html>